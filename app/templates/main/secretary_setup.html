{% extends "base.html" %}

{% block title %}AI Secretary Setup{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>🤖 AI Secretary Setup</h1>
        <p class="text-muted">Configure your intelligent assistant for business communications and KYB monitoring.</p>
    </div>
</div>

<!-- Company Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">📋 Company Information</h5>
            </div>
            <div class="card-body">
                <form id="company-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="company-name" class="form-label">Company Name *</label>
                            <input type="text" class="form-control" id="company-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="vat-number" class="form-label">VAT Number</label>
                            <input type="text" class="form-control" id="vat-number" placeholder="DE123456789">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="address" class="form-label">Business Address</label>
                            <textarea class="form-control" id="address" rows="2"></textarea>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="business-area" class="form-label">Business Area</label>
                            <input type="text" class="form-control" id="business-area" placeholder="IT Services">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" placeholder="+49 123 456 789">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="info@company.com">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Communication Channels -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">📱 Communication Channels</h5>
            </div>
            <div class="card-body">
                <div id="channels-container">
                    <!-- Phone Channel -->
                    <div class="channel-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="phone-enabled">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <strong>📞 Phone</strong>
                            </div>
                            <div class="col-md-4">
                                <input type="tel" class="form-control" placeholder="+49 123 456 789" id="phone-number">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="voice-language">
                                    <option value="de-DE">German</option>
                                    <option value="en-US">English</option>
                                    <option value="uk-UA">Ukrainian</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="configureChannel('phone')">Configure</button>
                            </div>
                        </div>
                    </div>

                    <!-- Email Channel -->
                    <div class="channel-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email-enabled">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <strong>📧 Email</strong>
                            </div>
                            <div class="col-md-4">
                                <input type="email" class="form-control" placeholder="secretary@company.com" id="email-address">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="email-provider">
                                    <option value="gmail">Gmail</option>
                                    <option value="outlook">Outlook</option>
                                    <option value="custom">Custom SMTP</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="configureChannel('email')">Configure</button>
                            </div>
                        </div>
                    </div>

                    <!-- Telegram Channel -->
                    <div class="channel-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="telegram-enabled">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <strong>💬 Telegram</strong>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Bot Token" id="telegram-token">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" placeholder="@bot_username" id="telegram-username">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="configureChannel('telegram')">Configure</button>
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Channel -->
                    <div class="channel-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="whatsapp-enabled">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <strong>💚 WhatsApp</strong>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Business Account ID" id="whatsapp-account">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" placeholder="API Key" id="whatsapp-key">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="configureChannel('whatsapp')">Configure</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Instructions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">🤖 AI Instructions</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="ai-instructions" class="form-label">System Prompt for AI Model</label>
                    <textarea class="form-control" id="ai-instructions" rows="8" placeholder="You are a professional AI secretary for {company_name}..."></textarea>
                    <div class="form-text">Use {company_name}, {company_address}, {company_phone} as placeholders.</div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary" onclick="loadTemplate()">Load Template</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary" onclick="previewInstructions()">Preview</button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success" onclick="testInstructions()">Test AI</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Knowledge Base -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">📚 Knowledge Base</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="document-upload" class="form-label">Upload Documents</label>
                            <input type="file" class="form-control" id="document-upload" multiple accept=".pdf,.doc,.docx,.txt">
                            <div class="form-text">Supported formats: PDF, DOC, DOCX, TXT</div>
                        </div>
                        <button class="btn btn-primary" onclick="uploadDocuments()">📁 Upload Documents</button>
                    </div>
                    <div class="col-md-6">
                        <h6>Vector Store Status</h6>
                        <div id="documents-list">
                            <div class="text-muted">No documents uploaded yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KYB Settings -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">🔍 KYB (Know Your Business) Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="auto-check-counterparties" checked>
                            <label class="form-check-label" for="auto-check-counterparties">
                                Auto-check new counterparties
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="monitor-changes" checked>
                            <label class="form-check-label" for="monitor-changes">
                                Monitor changes daily
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sanctions-screening" checked>
                            <label class="form-check-label" for="sanctions-screening">
                                Sanctions screening
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="notification-email" class="form-label">Notification Email</label>
                            <input type="email" class="form-control" id="notification-email" placeholder="admin@company.com">
                        </div>
                        <div class="mb-3">
                            <label for="check-frequency" class="form-label">Check Frequency</label>
                            <select class="form-select" id="check-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick VAT Check -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">🔍 Quick VAT Check</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="quick-vat" placeholder="DE123456789">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="quick-country">
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="NL">Netherlands</option>
                            <option value="AT">Austria</option>
                            <option value="IT">Italy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="quickVATCheck()">🔍 Check Now</button>
                    </div>
                    <div class="col-md-2">
                        <div id="vat-check-status"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <div id="vat-check-result"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4 mb-4">
    <div class="col-12">
        <div class="d-flex gap-3">
            <button class="btn btn-success btn-lg" onclick="saveConfiguration()">💾 Save Configuration</button>
            <button class="btn btn-outline-primary btn-lg" onclick="testSetup()">🧪 Test Setup</button>
            <button class="btn btn-outline-secondary btn-lg" onclick="loadConfiguration()">📥 Load Existing</button>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="status-messages"></div>

{% endblock %}

{% block scripts %}
<script>
let currentCompanyId = null;

// Load default AI instructions template
function loadTemplate() {
    const template = `You are a professional AI secretary for {company_name}.

COMPANY INFORMATION:
- Name: {company_name}
- Address: {company_address}
- Phone: {company_phone}
- Email: {company_email}
- Business Area: {business_area}

YOUR TASKS:
1. Answer questions about the company
2. Schedule appointments and meetings
3. Collect contact information from clients
4. Perform KYB checks on new counterparties
5. Notify about important changes and alerts

COMMUNICATION STYLE:
- Professional and friendly
- Clear and concise responses
- Always ask permission before recording data
- Use the client's preferred language

LIMITATIONS:
- Do not share confidential information
- Do not make financial decisions
- Escalate complex issues to human staff
- Always verify counterparty information through KYB checks

SECURITY:
- Perform automatic sanctions screening
- Monitor counterparty changes
- Alert on high-risk entities
- Maintain audit trail of all interactions`;

    document.getElementById('ai-instructions').value = template;
}

// Preview AI instructions with company data
function previewInstructions() {
    const instructions = document.getElementById('ai-instructions').value;
    const companyName = document.getElementById('company-name').value || '{company_name}';
    const companyAddress = document.getElementById('address').value || '{company_address}';
    const companyPhone = document.getElementById('phone').value || '{company_phone}';
    const companyEmail = document.getElementById('email').value || '{company_email}';
    const businessArea = document.getElementById('business-area').value || '{business_area}';
    
    const preview = instructions
        .replace(/{company_name}/g, companyName)
        .replace(/{company_address}/g, companyAddress)
        .replace(/{company_phone}/g, companyPhone)
        .replace(/{company_email}/g, companyEmail)
        .replace(/{business_area}/g, businessArea);
    
    showModal('AI Instructions Preview', `<pre>${preview}</pre>`);
}

// Test AI instructions
function testInstructions() {
    showMessage('info', 'AI testing functionality will be implemented in the next phase.');
}

// Configure communication channel
function configureChannel(channelType) {
    showMessage('info', `${channelType.charAt(0).toUpperCase() + channelType.slice(1)} channel configuration will be implemented in the next phase.`);
}

// Upload documents to knowledge base
function uploadDocuments() {
    const fileInput = document.getElementById('document-upload');
    if (fileInput.files.length === 0) {
        showMessage('warning', 'Please select files to upload.');
        return;
    }
    
    showMessage('info', 'Document upload functionality will be implemented in the next phase.');
}

// Quick VAT check
async function quickVATCheck() {
    const vatNumber = document.getElementById('quick-vat').value.trim();
    const countryCode = document.getElementById('quick-country').value;
    
    if (!vatNumber) {
        showMessage('warning', 'Please enter a VAT number.');
        return;
    }
    
    const statusDiv = document.getElementById('vat-check-status');
    const resultDiv = document.getElementById('vat-check-result');
    
    statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
    resultDiv.innerHTML = '';
    
    try {
        const response = await fetch('/api/v1/secretary/vat-check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vat_number: vatNumber,
                country_code: countryCode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const result = data.data;
            statusDiv.innerHTML = `<span class="badge bg-${result.status === 'valid' ? 'success' : 'danger'}">${result.status.toUpperCase()}</span>`;
            
            if (result.status === 'valid') {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>✅ Valid VAT Number</strong><br>
                        <strong>Company:</strong> ${result.name || 'N/A'}<br>
                        <strong>Address:</strong> ${result.address || 'N/A'}<br>
                        <strong>Response Time:</strong> ${result.response_time_ms}ms
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>❌ Invalid VAT Number</strong><br>
                        ${result.error || 'VAT number not found'}
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = '<span class="badge bg-danger">ERROR</span>';
            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error?.message || 'Unknown error'}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = '<span class="badge bg-danger">ERROR</span>';
        resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
    }
}

// Save configuration
async function saveConfiguration() {
    const companyData = {
        name: document.getElementById('company-name').value,
        vat_number: document.getElementById('vat-number').value,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        business_area: document.getElementById('business-area').value,
        ai_instructions: document.getElementById('ai-instructions').value
    };
    
    if (!companyData.name) {
        showMessage('warning', 'Company name is required.');
        return;
    }
    
    try {
        const url = currentCompanyId ? 
            `/api/v1/secretary/companies/${currentCompanyId}` : 
            '/api/v1/secretary/companies';
        
        const method = currentCompanyId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(companyData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCompanyId = data.data.id;
            showMessage('success', 'Configuration saved successfully!');
            
            // Save channels
            await saveChannels();
        } else {
            showMessage('danger', `Error: ${data.error?.message || 'Unknown error'}`);
        }
    } catch (error) {
        showMessage('danger', `Network error: ${error.message}`);
    }
}

// Save communication channels
async function saveChannels() {
    if (!currentCompanyId) return;
    
    const channels = [
        {
            channel_type: 'phone',
            enabled: document.getElementById('phone-enabled').checked,
            config: {
                number: document.getElementById('phone-number').value,
                language: document.getElementById('voice-language').value
            }
        },
        {
            channel_type: 'email',
            enabled: document.getElementById('email-enabled').checked,
            config: {
                address: document.getElementById('email-address').value,
                provider: document.getElementById('email-provider').value
            }
        },
        {
            channel_type: 'telegram',
            enabled: document.getElementById('telegram-enabled').checked,
            config: {
                token: document.getElementById('telegram-token').value,
                username: document.getElementById('telegram-username').value
            }
        }
    ];
    
    for (const channel of channels) {
        if (channel.enabled) {
            try {
                await fetch(`/api/v1/secretary/companies/${currentCompanyId}/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(channel)
                });
            } catch (error) {
                console.error('Error saving channel:', error);
            }
        }
    }
}

// Test setup
function testSetup() {
    showMessage('info', 'Setup testing functionality will be implemented in the next phase.');
}

// Load existing configuration
function loadConfiguration() {
    showMessage('info', 'Configuration loading functionality will be implemented in the next phase.');
}

// Utility functions
function showMessage(type, message) {
    const alertClass = type === 'danger' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' :
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const messageHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.getElementById('status-messages').innerHTML = messageHtml;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('#status-messages .alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

function showModal(title, content) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('preview-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="preview-modal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    document.querySelector('#preview-modal .modal-title').textContent = title;
    document.querySelector('#preview-modal .modal-body').innerHTML = content;
    
    const bootstrapModal = new bootstrap.Modal(document.getElementById('preview-modal'));
    bootstrapModal.show();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load default template
    loadTemplate();
    
    // Set default notification email from company email
    document.getElementById('email').addEventListener('change', function() {
        if (!document.getElementById('notification-email').value) {
            document.getElementById('notification-email').value = this.value;
        }
    });
});
</script>
{% endblock %}