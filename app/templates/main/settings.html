{% extends "base.html" %}

{% block title %}{{ _('Settings - AI Secretary') }}{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">{{ _('Settings') }}</h1>
                <p class="text-muted mb-0">{{ _('Manage your organization and system settings') }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Settings Navigation -->
    <div class="col-lg-3">
        <div class="card">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    <a href="#organization" class="list-group-item list-group-item-action active" data-bs-toggle="pill">
                        <i class="fas fa-building me-2"></i> {{ _('Organization') }}
                    </a>
                    <a href="#channels" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-comments me-2"></i> {{ _('Channels') }}
                    </a>
                    <a href="#ai-settings" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-robot me-2"></i> {{ _('AI Settings') }}
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-bell me-2"></i> {{ _('Notifications') }}
                    </a>
                    <a href="#billing" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-credit-card me-2"></i> {{ _('Billing') }}
                    </a>
                    <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-shield-alt me-2"></i> {{ _('Security') }}
                    </a>
                    <a href="#integrations" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                        <i class="fas fa-plug me-2"></i> {{ _('Integrations') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Content -->
    <div class="col-lg-9">
        <div class="tab-content">
            <!-- Organization Settings -->
            <div class="tab-pane fade show active" id="organization">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Organization Settings') }}</h5>
                    </div>
                    <div class="card-body">
                        <form id="organizationForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orgName" class="form-label">{{ _('Organization Name') }}</label>
                                    <input type="text" class="form-control" id="orgName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="orgDomain" class="form-label">{{ _('Domain') }}</label>
                                    <input type="text" class="form-control" id="orgDomain">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orgTimezone" class="form-label">{{ _('Timezone') }}</label>
                                    <select class="form-select" id="orgTimezone">
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">Eastern Time</option>
                                        <option value="America/Chicago">Central Time</option>
                                        <option value="America/Denver">Mountain Time</option>
                                        <option value="America/Los_Angeles">Pacific Time</option>
                                        <option value="Europe/London">London</option>
                                        <option value="Europe/Berlin">Berlin</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="orgLanguage" class="form-label">{{ _('Default Language') }}</label>
                                    <select class="form-select" id="orgLanguage">
                                        <option value="en">English</option>
                                        <option value="de">Deutsch</option>
                                        <option value="uk">Українська</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="orgDescription" class="form-label">{{ _('Description') }}</label>
                                <textarea class="form-control" id="orgDescription" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                {{ _('Save Changes') }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Channel Settings -->
            <div class="tab-pane fade" id="channels">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Channel Configuration') }}</h5>
                    </div>
                    <div class="card-body">
                        <!-- Telegram Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Telegram Bot') }}</h6>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="telegramToken" class="form-label">{{ _('Bot Token') }}</label>
                                    <input type="password" class="form-control" id="telegramToken" placeholder="Enter Telegram bot token">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ _('Status') }}</label>
                                    <div>
                                        <span class="badge bg-secondary" id="telegramStatus">{{ _('Not configured') }}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" onclick="testTelegramConnection()">
                                {{ _('Test Connection') }}
                            </button>
                        </div>
                        
                        <!-- Signal Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Signal Integration') }}</h6>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="signalPhone" class="form-label">{{ _('Phone Number') }}</label>
                                    <input type="tel" class="form-control" id="signalPhone" placeholder="+1234567890">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ _('Status') }}</label>
                                    <div>
                                        <span class="badge bg-secondary" id="signalStatus">{{ _('Not configured') }}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" onclick="testSignalConnection()">
                                {{ _('Test Connection') }}
                            </button>
                        </div>
                        
                        <!-- Web Widget Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Web Widget') }}</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="widgetColor" class="form-label">{{ _('Primary Color') }}</label>
                                    <input type="color" class="form-control form-control-color" id="widgetColor" value="#007bff">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="widgetPosition" class="form-label">{{ _('Position') }}</label>
                                    <select class="form-select" id="widgetPosition">
                                        <option value="bottom-right">{{ _('Bottom Right') }}</option>
                                        <option value="bottom-left">{{ _('Bottom Left') }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="widgetWelcome" class="form-label">{{ _('Welcome Message') }}</label>
                                <textarea class="form-control" id="widgetWelcome" rows="2" placeholder="Hello! How can I help you today?"></textarea>
                            </div>
                            <button class="btn btn-outline-primary" onclick="previewWidget()">
                                {{ _('Preview Widget') }}
                            </button>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveChannelSettings()">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ _('Save Channel Settings') }}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI Settings -->
            <div class="tab-pane fade" id="ai-settings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('AI Configuration') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="aiModel" class="form-label">{{ _('AI Model') }}</label>
                                <select class="form-select" id="aiModel">
                                    <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="aiTemperature" class="form-label">{{ _('Response Creativity') }}</label>
                                <input type="range" class="form-range" id="aiTemperature" min="0" max="1" step="0.1" value="0.7">
                                <div class="d-flex justify-content-between">
                                    <small>{{ _('Conservative') }}</small>
                                    <small>{{ _('Creative') }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="aiPersonality" class="form-label">{{ _('AI Personality') }}</label>
                            <textarea class="form-control" id="aiPersonality" rows="4" 
                                      placeholder="Describe how the AI should behave and respond to customers..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="aiInstructions" class="form-label">{{ _('System Instructions') }}</label>
                            <textarea class="form-control" id="aiInstructions" rows="4" 
                                      placeholder="Additional instructions for the AI system..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="aiAutoResponse" checked>
                                <label class="form-check-label" for="aiAutoResponse">
                                    {{ _('Enable automatic AI responses') }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="aiContentFilter" checked>
                                <label class="form-check-label" for="aiContentFilter">
                                    {{ _('Enable content filtering') }}
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveAISettings()">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ _('Save AI Settings') }}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notifications">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Notification Preferences') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Email Notifications') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailNewMessages" checked>
                                <label class="form-check-label" for="emailNewMessages">
                                    {{ _('New messages') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailNewLeads" checked>
                                <label class="form-check-label" for="emailNewLeads">
                                    {{ _('New leads') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailAppointments" checked>
                                <label class="form-check-label" for="emailAppointments">
                                    {{ _('Appointment reminders') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailKYBAlerts" checked>
                                <label class="form-check-label" for="emailKYBAlerts">
                                    {{ _('KYB monitoring alerts') }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Push Notifications') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pushNewMessages">
                                <label class="form-check-label" for="pushNewMessages">
                                    {{ _('New messages') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pushUrgentAlerts" checked>
                                <label class="form-check-label" for="pushUrgentAlerts">
                                    {{ _('Urgent alerts') }}
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ _('Save Notification Settings') }}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Billing Settings -->
            <div class="tab-pane fade" id="billing">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Billing & Subscription') }}</h5>
                    </div>
                    <div class="card-body">
                        <div id="billing-info">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">{{ _('Loading...') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Settings -->
            <div class="tab-pane fade" id="security">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Security Settings') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Password Policy') }}</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requireStrongPassword" checked>
                                <label class="form-check-label" for="requireStrongPassword">
                                    {{ _('Require strong passwords') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requirePasswordChange">
                                <label class="form-check-label" for="requirePasswordChange">
                                    {{ _('Require password change every 90 days') }}
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Session Management') }}</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sessionTimeout" class="form-label">{{ _('Session Timeout (hours)') }}</label>
                                    <input type="number" class="form-control" id="sessionTimeout" value="24" min="1" max="168">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Data Retention') }}</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="messageRetention" class="form-label">{{ _('Message Retention (days)') }}</label>
                                    <input type="number" class="form-control" id="messageRetention" value="365" min="30">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="logRetention" class="form-label">{{ _('Log Retention (days)') }}</label>
                                    <input type="number" class="form-control" id="logRetention" value="90" min="30">
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveSecuritySettings()">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ _('Save Security Settings') }}
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Integrations -->
            <div class="tab-pane fade" id="integrations">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Third-party Integrations') }}</h5>
                    </div>
                    <div class="card-body">
                        <!-- Google Calendar -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <h6 class="mb-1">{{ _('Google Calendar') }}</h6>
                                <small class="text-muted">{{ _('Sync appointments and availability') }}</small>
                            </div>
                            <div>
                                <span class="badge bg-secondary" id="googleCalendarStatus">{{ _('Not connected') }}</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="connectGoogleCalendar()">
                                    {{ _('Connect') }}
                                </button>
                            </div>
                        </div>
                        
                        <!-- Stripe -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <h6 class="mb-1">{{ _('Stripe') }}</h6>
                                <small class="text-muted">{{ _('Payment processing and invoicing') }}</small>
                            </div>
                            <div>
                                <span class="badge bg-success" id="stripeStatus">{{ _('Connected') }}</span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="configureStripe()">
                                    {{ _('Configure') }}
                                </button>
                            </div>
                        </div>
                        
                        <!-- Webhooks -->
                        <div class="mb-4">
                            <h6 class="text-primary">{{ _('Webhooks') }}</h6>
                            <div class="mb-3">
                                <label for="webhookUrl" class="form-label">{{ _('Webhook URL') }}</label>
                                <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-domain.com/webhook">
                            </div>
                            <div class="mb-3">
                                <label for="webhookEvents" class="form-label">{{ _('Events') }}</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="webhookNewMessage">
                                    <label class="form-check-label" for="webhookNewMessage">
                                        {{ _('New message received') }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="webhookNewLead">
                                    <label class="form-check-label" for="webhookNewLead">
                                        {{ _('New lead created') }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="webhookAppointment">
                                    <label class="form-check-label" for="webhookAppointment">
                                        {{ _('Appointment booked') }}
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" onclick="testWebhook()">
                                {{ _('Test Webhook') }}
                            </button>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveIntegrationSettings()">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            {{ _('Save Integration Settings') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load settings on page load
document.addEventListener('DOMContentLoaded', () => {
    loadOrganizationSettings();
    loadChannelSettings();
    loadAISettings();
    loadNotificationSettings();
    loadBillingInfo();
    loadSecuritySettings();
    loadIntegrationSettings();
});

// Load organization settings
async function loadOrganizationSettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/tenant/settings', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const settings = data.data?.settings || {};
            
            document.getElementById('orgName').value = settings.name || '';
            document.getElementById('orgDomain').value = settings.domain || '';
            document.getElementById('orgTimezone').value = settings.timezone || 'UTC';
            document.getElementById('orgLanguage').value = settings.language || 'en';
            document.getElementById('orgDescription').value = settings.description || '';
        }
        
    } catch (error) {
        console.error('Error loading organization settings:', error);
    }
}

// Save organization settings
async function saveOrganizationSettings(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        const token = localStorage.getItem('access_token');
        const headers = {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        };
        
        const response = await fetch('/api/v1/tenant/settings', {
            method: 'PUT',
            headers,
            body: JSON.stringify({
                name: document.getElementById('orgName').value,
                domain: document.getElementById('orgDomain').value,
                timezone: document.getElementById('orgTimezone').value,
                language: document.getElementById('orgLanguage').value,
                description: document.getElementById('orgDescription').value
            })
        });
        
        if (response.ok) {
            showAlert('success', '{{ _("Organization settings saved successfully") }}');
        } else {
            throw new Error('Failed to save settings');
        }
        
    } catch (error) {
        console.error('Error saving organization settings:', error);
        showAlert('danger', '{{ _("Failed to save organization settings") }}');
    } finally {
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    }
}

// Load channel settings
async function loadChannelSettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/channels/settings', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const settings = data.data?.settings || {};
            
            // Update channel status indicators
            updateChannelStatus('telegram', settings.telegram?.status);
            updateChannelStatus('signal', settings.signal?.status);
            
            // Load widget settings
            if (settings.web_widget) {
                document.getElementById('widgetColor').value = settings.web_widget.color || '#007bff';
                document.getElementById('widgetPosition').value = settings.web_widget.position || 'bottom-right';
                document.getElementById('widgetWelcome').value = settings.web_widget.welcome_message || '';
            }
        }
        
    } catch (error) {
        console.error('Error loading channel settings:', error);
    }
}

// Update channel status
function updateChannelStatus(channel, status) {
    const statusElement = document.getElementById(`${channel}Status`);
    if (statusElement) {
        statusElement.textContent = status || '{{ _("Not configured") }}';
        statusElement.className = `badge bg-${status === 'connected' ? 'success' : 'secondary'}`;
    }
}

// Load AI settings
async function loadAISettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/secretary/settings', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const settings = data.data?.settings || {};
            
            document.getElementById('aiModel').value = settings.model || 'gpt-4-turbo-preview';
            document.getElementById('aiTemperature').value = settings.temperature || 0.7;
            document.getElementById('aiPersonality').value = settings.personality || '';
            document.getElementById('aiInstructions').value = settings.instructions || '';
            document.getElementById('aiAutoResponse').checked = settings.auto_response !== false;
            document.getElementById('aiContentFilter').checked = settings.content_filter !== false;
        }
        
    } catch (error) {
        console.error('Error loading AI settings:', error);
    }
}

// Load notification settings
async function loadNotificationSettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/tenant/notification-settings', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const settings = data.data?.settings || {};
            
            // Email notifications
            document.getElementById('emailNewMessages').checked = settings.email?.new_messages !== false;
            document.getElementById('emailNewLeads').checked = settings.email?.new_leads !== false;
            document.getElementById('emailAppointments').checked = settings.email?.appointments !== false;
            document.getElementById('emailKYBAlerts').checked = settings.email?.kyb_alerts !== false;
            
            // Push notifications
            document.getElementById('pushNewMessages').checked = settings.push?.new_messages === true;
            document.getElementById('pushUrgentAlerts').checked = settings.push?.urgent_alerts !== false;
        }
        
    } catch (error) {
        console.error('Error loading notification settings:', error);
    }
}

// Load billing info
async function loadBillingInfo() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/billing/subscription', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const subscription = data.data?.subscription || {};
            
            const billingHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>{{ _('Current Plan') }}</h6>
                        <p class="mb-1"><strong>${subscription.plan_name || 'Trial'}</strong></p>
                        <p class="text-muted">${subscription.status || 'Active'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>{{ _('Next Billing Date') }}</h6>
                        <p class="mb-1">${subscription.next_billing_date ? formatDate(subscription.next_billing_date) : 'N/A'}</p>
                        <p class="text-muted">$${subscription.amount || 0}/month</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary me-2" onclick="manageBilling()">
                        {{ _('Manage Billing') }}
                    </button>
                    <button class="btn btn-outline-secondary" onclick="viewUsage()">
                        {{ _('View Usage') }}
                    </button>
                </div>
            `;
            
            document.getElementById('billing-info').innerHTML = billingHtml;
        } else {
            throw new Error('Failed to load billing info');
        }
        
    } catch (error) {
        console.error('Error loading billing info:', error);
        document.getElementById('billing-info').innerHTML = `
            <div class="alert alert-warning">{{ _('Unable to load billing information') }}</div>
        `;
    }
}

// Load security settings
async function loadSecuritySettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/tenant/security-settings', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const settings = data.data?.settings || {};
            
            document.getElementById('requireStrongPassword').checked = settings.require_strong_password !== false;
            document.getElementById('requirePasswordChange').checked = settings.require_password_change === true;
            document.getElementById('sessionTimeout').value = settings.session_timeout || 24;
            document.getElementById('messageRetention').value = settings.message_retention || 365;
            document.getElementById('logRetention').value = settings.log_retention || 90;
        }
        
    } catch (error) {
        console.error('Error loading security settings:', error);
    }
}

// Load integration settings
async function loadIntegrationSettings() {
    try {
        const token = localStorage.getItem('access_token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        
        const response = await fetch('/api/v1/tenant/integrations', { headers });
        
        if (response.ok) {
            const data = await response.json();
            const integrations = data.data?.integrations || {};
            
            // Update integration status
            updateIntegrationStatus('googleCalendar', integrations.google_calendar?.connected);
            updateIntegrationStatus('stripe', integrations.stripe?.connected);
            
            // Load webhook settings
            if (integrations.webhooks) {
                document.getElementById('webhookUrl').value = integrations.webhooks.url || '';
                document.getElementById('webhookNewMessage').checked = integrations.webhooks.events?.new_message === true;
                document.getElementById('webhookNewLead').checked = integrations.webhooks.events?.new_lead === true;
                document.getElementById('webhookAppointment').checked = integrations.webhooks.events?.appointment === true;
            }
        }
        
    } catch (error) {
        console.error('Error loading integration settings:', error);
    }
}

// Update integration status
function updateIntegrationStatus(integration, connected) {
    const statusElement = document.getElementById(`${integration}Status`);
    if (statusElement) {
        statusElement.textContent = connected ? '{{ _("Connected") }}' : '{{ _("Not connected") }}';
        statusElement.className = `badge bg-${connected ? 'success' : 'secondary'}`;
    }
}

// Event handlers
document.getElementById('organizationForm').addEventListener('submit', saveOrganizationSettings);

// Save functions
async function saveChannelSettings() {
    // TODO: Implement save channel settings
    showAlert('success', '{{ _("Channel settings saved") }}');
}

async function saveAISettings() {
    // TODO: Implement save AI settings
    showAlert('success', '{{ _("AI settings saved") }}');
}

async function saveNotificationSettings() {
    // TODO: Implement save notification settings
    showAlert('success', '{{ _("Notification settings saved") }}');
}

async function saveSecuritySettings() {
    // TODO: Implement save security settings
    showAlert('success', '{{ _("Security settings saved") }}');
}

async function saveIntegrationSettings() {
    // TODO: Implement save integration settings
    showAlert('success', '{{ _("Integration settings saved") }}');
}

// Test functions
function testTelegramConnection() {
    // TODO: Implement Telegram connection test
    showAlert('info', '{{ _("Testing Telegram connection...") }}');
}

function testSignalConnection() {
    // TODO: Implement Signal connection test
    showAlert('info', '{{ _("Testing Signal connection...") }}');
}

function previewWidget() {
    // TODO: Implement widget preview
    showAlert('info', '{{ _("Widget preview coming soon") }}');
}

function testWebhook() {
    // TODO: Implement webhook test
    showAlert('info', '{{ _("Testing webhook...") }}');
}

// Integration functions
function connectGoogleCalendar() {
    // TODO: Implement Google Calendar connection
    showAlert('info', '{{ _("Google Calendar connection coming soon") }}');
}

function configureStripe() {
    // TODO: Implement Stripe configuration
    showAlert('info', '{{ _("Stripe configuration coming soon") }}');
}

function manageBilling() {
    // TODO: Implement billing management
    showAlert('info', '{{ _("Billing management coming soon") }}');
}

function viewUsage() {
    // TODO: Implement usage view
    showAlert('info', '{{ _("Usage view coming soon") }}');
}

// Utility functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}